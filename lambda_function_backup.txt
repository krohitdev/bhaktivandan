import { SESClient, SendEmailCommand } from "@aws-sdk/client-ses";
import https from 'https';

const sesClient = new SESClient({ region: process.env.AWS_REG });

export const handler = async (event) => {
  try {
    console.log("EVENT:", JSON.stringify(event));
    // Parse request body
    const body = JSON.parse(event.body || "{}");
    // const body =
    //   typeof event.body === "string"
    //     ? JSON.parse(event.body)
    //     : event.body;
    // const body  = {
    //   name :"lambda test",
    //   email: "test@nomail.com",
    //   message: "test message"
    // }
    
    const { name, email, message, captchaToken } = body;

    // Basic validation
    if (!captchaToken) {
      return response(400, { error: "Missing reCAPTCHA" }, event);
    }

    if (!name || !email || !message) {
      return response(400, {
        success: false,
        message: "Name, email, and message are required"
      });
    }

    // ğŸ” Verify reCAPTCHA
    const isHuman = await verifyRecaptcha(captchaToken);
    if (!isHuman) {
      return response(403, { error: "reCAPTCHA failed" }, event);
    }

    const params = {
      Source: process.env.FROM_EMAIL, // Verified SES email
      Destination: {
        ToAddresses: [process.env.TO_EMAIL]
      },
      Message: {
        Subject: {
          Data: `New Contact Request â€“ Bhakti Vandan (from ${name})`
        },
        Body: {
          Text: {
            Data: `
Hello Admin

    You have received a new message from the Bhakti Vandan website. 

Name: ${name}
Email: ${email}

Message:
${message}

--
Bhakti Vandan
https://www.bhaktivandan.com
India
`
          }
        }
      }
    };

    let emailObj = await sesClient.send(new SendEmailCommand(params));
    console.log('event ', emailObj)
    return response(200, {
      success: true,
      message: "Email sent successfully"
    });

  } catch (error) {
    console.error("SES Error:", error);

    return response(500, {
      success: false,
      message: "Failed to send email"
    });
  }
};

const response = (statusCode, body) => ({
  statusCode,
  headers: {
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Allow-Headers": "Content-Type",
    "Access-Control-Allow-Methods": "POST,OPTIONS"
  },
  body: JSON.stringify(body)
});

// ğŸ” reCAPTCHA verification
const verifyRecaptcha = function (token) {
  const secret = process.env.RECAPTCHA_SECRET;

  const data = `secret=${secret}&response=${token}`;

  return new Promise((resolve) => {
    const req = https.request(
      {
        hostname: "hcaptcha.com",
        path: "/siteverify",
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "Content-Length": Buffer.byteLength(data)
        }
      },
      (res) => {
        let body = "";
        res.on("data", (chunk) => (body += chunk));
        res.on("end", () => {
          try {
            const result = JSON.parse(body);
            resolve(result.success === true);
          } catch (err) {
            resolve(false);
          }
        });
      }
    );

    req.on("error", () => resolve(false));

    req.write(data);
    req.end();
  });
}